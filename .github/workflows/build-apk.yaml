name: Build Android APK

# Use https://github.com/nektos/act to run this locally
# INSTALL:
#   curl --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
# PREPARE: you need to have a `testnet` project in EAS:
#   export EXPO_NODE_ENV=testnet
#   export EXPO_FIRST_TIME=true
#   yarn run build:android
#   echo "Set the value of `expoProjectId` in src/config/config.testnet.json"
#   echo "Get an access token from https://expo.dev/accounts/[account]/settings/access-tokens"
#   export EXPO_TOKEN=rtsB...
# RUN:
#   act -j build-android -s EXPO_TOKEN="${EXPO_TOKEN}"

on:
  push

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      EXPO_NODE_ENV: testnet
      EXPO_PLATFORM: android
      NODE_VERSION: 22.3.0
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_SECRET_KEY: ${{ secrets.SENTRY_SECRET_KEY }}
      SENTRY_PROJECT_ID: ${{ secrets.SENTRY_PROJECT_ID }}
      SENTRY_PUBLIC_KEY: ${{ secrets.SENTRY_PUBLIC_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup disk space
        run: |
          echo "Initial disk space:"
          df -h
          # Clean system caches
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          
      - name: Install Node.js with corepack
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: |
          yarn --immutable --prefer-offline

      - name: Install EAS CLI
        run: npm install -g eas-cli@16.3.3

      - name: Clean Android SDK (keep only necessary components)
        run: |
          # Remove unnecessary Android SDK components
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --uninstall "emulator" || true
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --uninstall "system-images;android-30;google_apis;x86_64" || true
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --uninstall "system-images;android-29;google_apis;x86_64" || true
          # Keep only the necessary build tools and platforms
          echo "Current Android packages:"
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed

      - name: Clear caches before build
        run: |
          # Clear various caches
          yarn cache clean
          npm cache clean --force
          rm -rf ~/.cache
          rm -rf ~/.npm
          # Clear Android/Gradle caches but keep SDK
          rm -rf ~/.gradle/caches
          rm -rf ~/.android/build-cache
          # Clear temporary files
          sudo rm -rf /tmp/*

      - name: Check disk space before build
        run: df -h

      - name: ðŸš€ Build Android .apk app
        run: |
          yarn run build:prepare
          npx eas build --clear-cache --profile "${{env.EXPO_NODE_ENV}}-internal" --platform "${EXPO_PLATFORM}" --local
        env:
          SENTRY_SECRET_KEY: ${{ secrets.SENTRY_SECRET_KEY }}

      - name: Find and rename APK file
        run: find . -name "*.apk" -exec mv {} "Tonomy-ID-${{env.EXPO_NODE_ENV}}.apk" \;

      - name: Archive Android APK as artifact
        if: ${{ github.actor != 'nektos/act' }}
        uses: actions/upload-artifact@v4
        with:
          name: "TonomyID-Android-${{env.EXPO_NODE_ENV}}"
          path: "./Tonomy-ID-${{env.EXPO_NODE_ENV}}.apk"