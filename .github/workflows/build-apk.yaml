name: Build Android APK

on:
  push

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      EXPO_NODE_ENV: testnet
      EXPO_PLATFORM: android
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_SECRET_KEY: ${{ secrets.SENTRY_SECRET_KEY }}
      SENTRY_PROJECT_ID: ${{ secrets.SENTRY_PROJECT_ID }}
      SENTRY_PUBLIC_KEY: ${{ secrets.SENTRY_PUBLIC_KEY }}

    container:
      image: cimg/android:2025.10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.3.0
          cache: 'yarn'

      - name: Install dependencies
        run: yarn --immutable

      - name: Install EAS CLI
        run: npm install -g eas-cli@16.3.3

      - name: Build Android APK
        run: |
          yarn run build:prepare
          npx eas build --clear-cache --platform android --profile testnet-internal --local
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          SENTRY_SECRET_KEY: ${{ secrets.SENTRY_SECRET_KEY }}

      - name: Find and rename APK
        run: |
          find . -name "*.apk" -exec mv {} "Tonomy-ID-${{env.EXPO_NODE_ENV}}.apk" \;

      - name: Upload APK artifact
        if: ${{ github.actor != 'nektos/act' }}
        uses: actions/upload-artifact@v4
        with:
          name: "TonomyID-Android-${{env.EXPO_NODE_ENV}}"
          path: "./Tonomy-ID-${{env.EXPO_NODE_ENV}}.apk"
